---
- name: Bootstrap Flux on the cluster
  hosts: localhost
  gather_facts: false
  tasks:
  - name: Check if Flux is enabled
    assert:
      that:
        - flux == 'enabled'
      fail_msg: "Flux is not enabled. Skipping Flux bootstrap."

  - name: Validate gitProvider
    assert:
      that:
        - gitProvider in ['github', 'gitlab', 'git']
      fail_msg: "Invalid gitProvider. Must be one of: github, gitlab, git."

  - name: Check if flux command is available
    command: which flux
    register: flux_command
    failed_when: flux_command.rc != 0
    changed_when: false

  # To bootstrap Flux, it is required that the person running the playbook to be
  # the owner of the GitLab project, or to have admin rights of a GitLab group.
  - name: Bootstrap Flux ... it can take up to 60 sec.
    command: >
      flux bootstrap {{ gitProvider }}
      --namespace=flux-system
      --token-auth
      --owner={{ owner }}
      --repository={{ repository }}
      --branch={{ branch }}
      --path={{ path | default('clusters/kamaji') }}
    when:
      - flux == 'enabled'
      - gitProvider in ['github', 'gitlab', 'git']
    environment:
      GITHUB_TOKEN: "{{ lookup('env', 'GITHUB_TOKEN') }}"
      GITLAB_TOKEN: "{{ lookup('env', 'GITLAB_TOKEN') }}"

